<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Mermaid Live Editor</title>
    <link rel="stylesheet" href="/src/styles.css" />
  </head>
  <body>
    <div class="bg"></div>
    <main class="app">
      <header class="hero">
        <div>
          <p class="eyebrow">AI Mermaid Live Editor</p>
          <h1>Design, render, and patch Mermaid diagrams in one place.</h1>
          <p class="subhead">Live render, diff previews, share links, and exports. Local-first.</p>
        </div>
        <div class="hero-actions">
          <button id="help" class="ghost" type="button">Shortcuts</button>
          <button id="theme-toggle" class="ghost" type="button">Toggle theme</button>
          <button id="copy-link" type="button">Copy share link</button>
          <button id="copy-link-newtab" class="ghost" type="button" title="Adds ?tab=new so opening the link imports into a new diagram tab.">
            Copy link (new tab)
          </button>
        </div>
        <div id="readonly-banner" class="banner" hidden>Read-only snapshot</div>
      </header>

      <section class="workspace" id="workspace-start">
        <div class="panel template-panel">
          <div class="panel-head">
            <div>
              <h2>Starter templates</h2>
              <div class="hint">Pick a proven structure, then customize it.</div>
            </div>
            <div class="template-search">
              <input id="template-search" type="search" placeholder="Search templates" />
            </div>
          </div>
          <div id="template-filters" class="template-filters"></div>
          <div class="toolbar">
            <button id="save-template" class="ghost" type="button">Save current as template</button>
            <button id="export-templates" class="ghost" type="button">Export templates</button>
            <button id="import-templates-btn" class="ghost" type="button">Import templates</button>
            <input id="import-templates-input" type="file" accept="application/json,.json" hidden />
          </div>
          <div id="template-grid" class="template-grid"></div>
          <div id="template-empty" class="hint" hidden>No templates match your search.</div>
        </div>
        <div class="panel">
          <div class="panel-head">
            <div>
              <h2>Project brief</h2>
              <div class="hint">Keep context with your diagram exports.</div>
            </div>
          </div>
          <label class="label" for="project-title">Project title</label>
          <input id="project-title" type="text" placeholder="e.g. Pricing revamp" />
          <label class="label" for="project-audience">Audience</label>
          <input id="project-audience" type="text" placeholder="e.g. Exec review" />
          <label class="label" for="project-owner">Owner</label>
          <input id="project-owner" type="text" placeholder="e.g. You / team" />
          <label class="label" for="project-purpose">Purpose</label>
          <textarea id="project-purpose" placeholder="What decision does this diagram support?"></textarea>
          <label class="field checkbox">
            <input id="use-filenames" type="checkbox" />
            <span>Use project + tab name in filenames</span>
          </label>
          <div class="toolbar">
            <button id="copy-snapshot" type="button">Copy snapshot link</button>
            <button id="copy-snapshot-import" class="ghost" type="button" title="Creates an importable snapshot that opens as a new tab (not read-only).">
              Copy snapshot (import)
            </button>
            <button id="download-bundle" class="ghost" type="button">Download bundle</button>
          </div>
        </div>
      </section>

      <section class="workspace" id="workspace-editor">
        <div class="panel" id="editor-panel">
          <div class="panel-head">
            <h2>Mermaid editor</h2>
            <div class="hint">Live render with inline errors. Ctrl/Cmd + Enter to apply patch.</div>
          </div>
          <div class="tabs" id="tabs">
            <div class="tab-list" id="tab-list"></div>
            <div class="tab-actions">
              <button id="add-tab" class="ghost" type="button">New tab</button>
              <button id="duplicate-tab" class="ghost" type="button">Duplicate</button>
              <button id="rename-tab" class="ghost" type="button">Rename</button>
              <button id="delete-tab" class="ghost" type="button">Delete</button>
            </div>
          </div>
          <textarea id="editor" spellcheck="false"></textarea>
          <div class="toolbar">
            <button id="commit" type="button">Commit snapshot</button>
            <button id="export-svg" class="ghost" type="button">Export SVG</button>
            <button id="export-png" class="ghost" type="button">Export PNG</button>
            <button id="export-pdf" class="ghost" type="button">Export PDF</button>
            <button id="format-mermaid" class="ghost" type="button">Format Mermaid</button>
            <button id="lint-mermaid" class="ghost" type="button">Lint Mermaid</button>
            <button id="copy-source" class="ghost" type="button">Copy Mermaid</button>
            <button id="copy-svg" class="ghost" type="button">Copy SVG</button>
            <button id="copy-png" class="ghost" type="button">Copy PNG</button>
          </div>
          <div class="stats" id="stats"></div>
          <div class="hint" id="health"></div>
          <div class="lint-box">
            <div class="lint-head">
              <div class="label">Lint assistant</div>
              <button id="lint-stage-fixes" class="ghost" type="button">Stage quick fixes</button>
            </div>
            <div id="lint-status" class="hint">Lint: run to detect common Mermaid issues.</div>
            <div id="lint-issues" class="lint-issues"><div class="hint">No findings.</div></div>
          </div>
        </div>

        <div class="panel" id="render-panel">
          <div class="panel-head">
            <div>
              <h2>Live render</h2>
              <div class="hint" id="render-status" role="status" aria-live="polite" aria-atomic="true">Ready</div>
            </div>
            <div class="render-actions">
              <button id="render-now" class="ghost" type="button">Render now</button>
              <button id="jump-error" class="ghost" type="button" hidden>Jump to error</button>
              <button id="focus-toggle" class="ghost" type="button" aria-pressed="false">Focus</button>
            </div>
          </div>
          <div class="render-toolbar">
            <div class="zoom-controls">
              <button id="zoom-out" class="ghost" type="button" aria-label="Zoom out">−</button>
              <span id="zoom-label" class="hint">100%</span>
              <button id="zoom-in" class="ghost" type="button" aria-label="Zoom in">+</button>
              <button id="zoom-reset" class="ghost" type="button">Reset</button>
            </div>
          </div>
          <div id="preview" class="preview">
            <div id="preview-content" class="preview-content"></div>
          </div>
          <div class="render-exports">
            <div id="export-summary" class="hint">Export summary updates after render.</div>
            <div class="toolbar">
              <button data-action="export-svg" class="ghost" type="button">Export SVG</button>
              <button data-action="export-png" class="ghost" type="button">Export PNG</button>
              <button data-action="export-pdf" class="ghost" type="button">Export PDF</button>
              <button data-action="copy-svg" class="ghost" type="button">Copy SVG</button>
              <button data-action="copy-png" class="ghost" type="button">Copy PNG</button>
            </div>
          </div>
        </div>
      </section>

      <section class="workspace" id="workspace-ai">
        <div class="panel">
          <div class="panel-head">
            <h2>AI patch studio</h2>
            <div class="hint">Paste or generate patch proposals, then apply with preview.</div>
          </div>
          <details class="provider-settings">
            <summary>AI provider settings</summary>
            <div class="provider-grid">
              <label class="field">
                <span>API base URL</span>
                <input id="ai-api-base" type="text" placeholder="http://127.0.0.1:8787/v1 or https://api.openai.com/v1" />
              </label>
              <label class="field">
                <span>Model</span>
                <input id="ai-model" type="text" placeholder="e.g. gpt-4.1" />
              </label>
              <label class="field">
                <span>API mode</span>
                <select id="ai-api-mode">
                  <option value="chat">Chat Completions</option>
                  <option value="responses">Responses</option>
                </select>
              </label>
              <label class="field">
                <span>Temperature</span>
                <input id="ai-temperature" type="number" min="0" max="2" step="0.1" placeholder="e.g. 0.2" />
              </label>
              <label class="field">
                <span>Max tokens</span>
                <input id="ai-max-tokens" type="number" min="1" step="50" placeholder="e.g. 800" />
              </label>
              <label class="field">
                <span>Timeout (seconds)</span>
                <input id="ai-timeout" type="number" min="5" max="180" step="5" placeholder="45" />
              </label>
              <label class="field">
                <span>API key</span>
                <input id="ai-api-key" type="password" placeholder="Optional when using local proxy" />
              </label>
              <label class="field checkbox">
                <input id="ai-remember-key" type="checkbox" />
                <span>Remember API key on this device (not recommended)</span>
              </label>
              <div class="hint">
                Tip: run <code>OPENAI_API_KEY=… node scripts/ai-proxy.mjs</code> and set base URL to
                <code>http://127.0.0.1:8787/v1</code>.
              </div>
            </div>
          </details>
          <div class="label">Prompt recipes</div>
          <div id="prompt-recipes" class="prompt-recipes"></div>
          <label class="label" for="instructions">Instructions</label>
          <textarea id="instructions" placeholder="Refactor the flow into swimlanes with explicit approvals."></textarea>
          <div class="toolbar">
            <button id="generate-patch" type="button">Generate AI patch</button>
            <button id="cancel-generate-patch" class="ghost" type="button" disabled>Cancel</button>
            <button id="simulate" class="ghost" type="button">Simulate patch</button>
            <button id="apply-patch" class="ghost" type="button">Apply patch</button>
          </div>
          <div id="ai-status" class="hint" role="status" aria-live="polite" aria-atomic="true"></div>
          <div id="ai-usage" class="hint" aria-live="polite" aria-atomic="true"></div>
          <div id="patch-undo" class="undo-row" hidden>
            <span>Patch applied.</span>
            <button id="undo-patch" class="ghost" type="button">Undo</button>
          </div>
          <label class="label" for="proposal">Patch proposal</label>
          <textarea id="proposal" placeholder="AI patch output will appear here."></textarea>
        </div>

        <div class="panel">
          <div class="panel-head">
            <h2>Diff preview</h2>
            <div class="hint">Line diff between current and proposed diagram.</div>
          </div>
          <div id="diff" class="diff"></div>
        </div>
      </section>

      <section class="workspace" id="workspace-ops">
        <div class="panel">
          <div class="panel-head">
            <h2>Commit timeline</h2>
            <div class="hint">Snapshots are stored locally in your browser.</div>
          </div>
          <div id="timeline" class="timeline"></div>
        </div>

        <div class="panel">
          <div class="panel-head">
            <h2>Quick actions</h2>
          </div>
          <div class="quick-actions">
            <button id="reset" class="ghost" type="button">Reset to starter</button>
            <button id="clear-history" class="ghost" type="button">Clear history</button>
            <button id="download-history" type="button">Download history JSON</button>
            <button id="presentation-mode" class="ghost" type="button">Presentation mode</button>
            <button id="restore-draft" class="ghost" type="button">Restore draft</button>
            <button id="clear-draft" class="ghost" type="button">Clear draft</button>
            <button id="download-source" class="ghost" type="button">Download Mermaid</button>
            <button id="import-file-btn" class="ghost" type="button">Import Mermaid file</button>
            <button id="import-url-btn" class="ghost" type="button">Import from URL</button>
            <input id="import-file" type="file" accept=".mmd,.md,.txt,text/plain,text/markdown" hidden />
            <div class="export-controls">
              <div class="label">Export settings</div>
              <label class="field">
                <span>Preset</span>
                <select id="export-preset">
                  <option value="default">Default</option>
                </select>
              </label>
              <label class="field">
                <span>Preset name</span>
                <input id="export-preset-name" type="text" maxlength="40" placeholder="e.g. Blog hero" />
              </label>
              <div class="toolbar">
                <button id="save-preset" class="ghost" type="button">Save preset</button>
                <button id="delete-preset" class="ghost" type="button">Delete preset</button>
              </div>
              <label class="field">
                <span>PNG scale</span>
                <select id="export-scale">
                  <option value="1">1x</option>
                  <option value="1.5">1.5x</option>
                  <option value="2">2x</option>
                  <option value="3">3x</option>
                </select>
              </label>
              <label class="field">
                <span>Export width</span>
                <select id="export-width">
                  <option value="auto">Auto</option>
                  <option value="640">Small (640px)</option>
                  <option value="960">Medium (960px)</option>
                  <option value="1280">Large (1280px)</option>
                  <option value="custom">Custom…</option>
                </select>
              </label>
              <label class="field">
                <span>Custom width</span>
                <input id="export-width-custom" type="number" min="200" max="4000" step="50" placeholder="e.g. 1440" />
              </label>
              <label class="field checkbox">
                <input id="export-transparent" type="checkbox" />
                <span>Transparent PNG</span>
              </label>
              <label class="field">
                <span>SVG scale</span>
                <select id="export-svg-scale">
                  <option value="1">1x</option>
                  <option value="1.5">1.5x</option>
                  <option value="2">2x</option>
                </select>
              </label>
              <label class="field checkbox">
                <input id="export-svg-inline" type="checkbox" />
                <span>Inline SVG styles</span>
              </label>
              <label class="field checkbox">
                <input id="export-svg-minify" type="checkbox" />
                <span>Minify SVG</span>
              </label>
              <label class="field">
                <span>PDF page</span>
                <select id="pdf-page">
                  <option value="auto">Auto</option>
                  <option value="letter">Letter</option>
                  <option value="a4">A4</option>
                </select>
              </label>
              <label class="field">
                <span>PDF orientation</span>
                <select id="pdf-orientation">
                  <option value="auto">Auto</option>
                  <option value="portrait">Portrait</option>
                  <option value="landscape">Landscape</option>
                </select>
              </label>
              <label class="field">
                <span>PDF margin</span>
                <select id="pdf-margin">
                  <option value="6">Small (6mm)</option>
                  <option value="12">Medium (12mm)</option>
                  <option value="18">Large (18mm)</option>
                </select>
              </label>
              <label class="field checkbox">
                <input id="pdf-white-bg" type="checkbox" />
                <span>White PDF background</span>
              </label>
            </div>
            <div class="export-history">
              <div class="label">Recent exports</div>
              <div class="toolbar">
                <button id="download-export-history" class="ghost" type="button">Download export history JSON</button>
              </div>
              <div id="export-history" class="hint">No exports yet.</div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <dialog id="shortcuts-dialog" class="dialog" aria-labelledby="shortcuts-title">
      <div class="dialog-head">
        <h2 id="shortcuts-title">Keyboard shortcuts</h2>
        <button id="shortcuts-close" class="ghost" type="button">Close</button>
      </div>
      <div class="dialog-body">
        <div class="shortcut-row">
          <kbd>Ctrl</kbd>/<kbd>Cmd</kbd> + <kbd>Enter</kbd>
          <span>Apply patch</span>
        </div>
        <div class="shortcut-row">
          <kbd>Ctrl</kbd>/<kbd>Cmd</kbd> + <kbd>S</kbd>
          <span>Commit snapshot</span>
        </div>
        <div class="shortcut-row">
          <kbd>?</kbd>
          <span>Open shortcuts</span>
        </div>
        <div class="shortcut-row">
          <kbd>P</kbd>
          <span>Open presentation mode</span>
        </div>
        <div class="shortcut-row">
          <kbd>F</kbd>
          <span>Toggle focus mode</span>
        </div>
        <div class="shortcut-row">
          <kbd>Space</kbd> + <span>Drag</span>
          <span>Pan preview</span>
        </div>
        <div class="shortcut-row">
          <kbd>Esc</kbd>
          <span>Exit focus mode</span>
        </div>
        <p class="hint">Shortcuts work from anywhere; Ctrl/Cmd + S overrides the browser save dialog.</p>
      </div>
    </dialog>

    <dialog id="import-url-dialog" class="dialog" aria-labelledby="import-url-title">
      <div class="dialog-head">
        <h2 id="import-url-title">Import from URL</h2>
        <button id="import-url-close" class="ghost" type="button">Close</button>
      </div>
      <div class="dialog-body">
        <p class="hint">Paste a URL to a Mermaid file, or paste a share link/hash from this app.</p>
        <label class="label" for="import-url-input">URL or share link</label>
        <textarea id="import-url-input" placeholder="https://example.com/diagram.mmd or #snap:..." rows="4"></textarea>
        <div class="toolbar">
          <button id="import-url-submit" type="button">Import as new tab</button>
          <button id="import-url-cancel" class="ghost" type="button">Cancel</button>
        </div>
        <p class="hint">Tip: some hosts block cross-origin fetches; in that case, download the file and use “Import Mermaid file”.</p>
      </div>
    </dialog>

    <dialog id="presentation-dialog" class="presentation-dialog" aria-labelledby="presentation-title">
      <div class="presentation-shell">
        <div class="presentation-bar">
          <div class="presentation-heading">
            <h2 id="presentation-title">Presentation mode</h2>
            <div id="presentation-meta" class="hint">Use Left/Right arrows to step through snapshots.</div>
          </div>
          <div class="presentation-actions">
            <button id="presentation-fullscreen" class="ghost" type="button">Fullscreen</button>
            <button id="presentation-prev" class="ghost" type="button">Prev</button>
            <button id="presentation-next" class="ghost" type="button">Next</button>
            <button id="presentation-close" class="ghost" type="button">Close</button>
          </div>
        </div>
        <div class="presentation-canvas">
          <div id="presentation-status" class="hint" role="status" aria-live="polite" aria-atomic="true"></div>
          <div class="presentation-stage">
            <div id="presentation-content" class="presentation-content"></div>
          </div>
        </div>
      </div>
    </dialog>

    <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true" hidden></div>

    <script type="module" src="/src/main.js"></script>
  </body>
</html>
